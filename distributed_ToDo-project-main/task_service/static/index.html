<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-image: url("starts.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
    }

    .glass-card {
      background: rgba(0, 0, 50, 0.4);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      padding: 2rem;
      width: 100%;
      max-width: 420px;
    }

    .form-control {
      background-color: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .form-control::placeholder { color: #eee; }
    h2 { color: #ffffff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
  </style>
</head>
<body>
<div class="glass-card">
  <div id="auth-form">
    <h2 class="text-center mb-4">âœ¨ ç™»å½•ä½ çš„æ¢¦å¹»ä»»åŠ¡ç³»ç»Ÿ</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="ç”¨æˆ·å">
    <input type="password" id="password" class="form-control mb-2" placeholder="å¯†ç ">
    <button class="btn btn-primary w-100 mb-2" onclick="login()">ç™»å½•</button>
    <button class="btn btn-outline-secondary w-100" onclick="register()">æ³¨å†Œ</button>
  </div>

  <div id="task-manager" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>ğŸŒ™ æˆ‘çš„ä»»åŠ¡</h2>
      <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <div class="mb-3">
      <input type="text" id="task-title" class="form-control mb-2" placeholder="ä»»åŠ¡æ ‡é¢˜">
      <textarea id="task-content" class="form-control mb-2" placeholder="ä»»åŠ¡å†…å®¹"></textarea>
      <button class="btn btn-success w-100" onclick="createTask()">æ·»åŠ ä»»åŠ¡</button>
    </div>

    <div class="mb-3">
      <input type="text" id="public-channel-code" class="form-control mb-2" placeholder="è¾“å…¥å…¬å…±é¢‘é“ç ">
      <button class="btn btn-outline-info w-100" onclick="viewPublicTask()">ğŸ“¡ æŸ¥çœ‹å…¬å…±ä»»åŠ¡</button>
      <button class="btn btn-outline-success w-100 mt-2" onclick="promptCreatePublicTask()">ğŸŒ åˆ›å»ºå…¬å…±ä»»åŠ¡</button>
    </div>

    <div id="task-list" class="mt-4"></div>
    <div id="public-task-view" class="mt-4"></div>
  </div>
</div>

<script>
  let authToken = localStorage.getItem('authToken');
  let loadedPublicTaskIds = new Set();

  async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const response = await fetch('http://localhost:8000/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (response.ok) {
      const data = await response.json();
      authToken = data.token;
      localStorage.setItem('authToken', authToken);
      document.getElementById('auth-form').style.display = 'none';
      document.getElementById('task-manager').style.display = 'block';
      loadTasks();
    } else alert('ç™»å½•å¤±è´¥');
  }

  async function register() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const response = await fetch('http://localhost:8000/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (response.ok) alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
    else alert('æ³¨å†Œå¤±è´¥');
  }

  async function logout() {
    localStorage.removeItem('authToken');
    authToken = null;
    document.getElementById('auth-form').style.display = 'block';
    document.getElementById('task-manager').style.display = 'none';
    document.getElementById('task-list').innerHTML = '';
    document.getElementById('public-task-view').innerHTML = '';
    document.getElementById('public-channel-code').value = '';
    loadedPublicTaskIds.clear();
    alert("æ‚¨å·²é€€å‡ºç™»å½•");
  }

  async function loadTasks() {
    const response = await fetch('http://localhost:8001/tasks', {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    const tasks = await response.json();
    const taskList = document.getElementById('task-list');
    taskList.innerHTML = '';
    for (const task of tasks) {
      if (task.is_public && task.channel_code) {
        if (!loadedPublicTaskIds.has(task.id)) {
          renderPublicTask(task, true);
          loadedPublicTaskIds.add(task.id);
        }
      } else {
        taskList.innerHTML += `
          <div class="card bg-dark bg-opacity-25 text-white mb-3">
            <div class="card-body">
              <h5>${task.title}</h5>
              <p>${task.content}</p>
              <button class="btn btn-outline-primary btn-sm me-2" onclick="editTask(${task.id}, '${task.title}', '${task.content}')">ç¼–è¾‘</button>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${task.id})">åˆ é™¤</button>
            </div>
          </div>
        `;
      }
    }
  }

  async function createTask() {
    const title = document.getElementById('task-title').value;
    const content = document.getElementById('task-content').value;
    const response = await fetch('http://localhost:8001/tasks', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ title, content })
    });
    if (response.ok) {
      document.getElementById('task-title').value = '';
      document.getElementById('task-content').value = '';
      loadTasks();
    } else {
      alert("ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼");
    }
  }

  async function editTask(id, oldTitle, oldContent) {
    const newTitle = prompt("ä¿®æ”¹ä»»åŠ¡æ ‡é¢˜ï¼š", oldTitle);
    const newContent = prompt("ä¿®æ”¹ä»»åŠ¡å†…å®¹ï¼š", oldContent);
    if (!newTitle || !newContent) return;
    const response = await fetch(`http://localhost:8001/tasks/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ title: newTitle, content: newContent })
    });
    if (response.ok) loadTasks();
    else alert("ä¿®æ”¹å¤±è´¥");
  }

  async function deleteTask(taskId) {
    await fetch(`http://localhost:8001/tasks/${taskId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    loadTasks();
  }

  function promptCreatePublicTask() {
    const title = prompt("è¾“å…¥å…¬å…±ä»»åŠ¡æ ‡é¢˜ï¼š");
    const content = prompt("è¾“å…¥å…¬å…±ä»»åŠ¡å†…å®¹ï¼š");
    const code = prompt("è®¾ç½®ä¸€ä¸ªé¢‘é“ç ï¼ˆè‹±æ–‡æˆ–æ•°å­—ï¼‰:");
    if (!title || !content || !code) return;
    createPublicTask(title, content, code);
  }

  async function createPublicTask(title, content, code) {
    const response = await fetch('http://localhost:8001/public_tasks/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ title, content, channel_code: code })
    });
    const result = await response.json();
    if (response.ok) {
      alert("åˆ›å»ºæˆåŠŸï¼Œé¢‘é“ç ä¸ºï¼š" + result.channel_code);
      renderPublicTask(result, true);
      loadedPublicTaskIds.add(result.id);
    } else {
      alert("åˆ›å»ºå¤±è´¥ï¼š" + result.detail);
    }
  }

  async function viewPublicTask() {
    const code = document.getElementById('public-channel-code').value;
    const response = await fetch(`http://localhost:8001/public_tasks/${code}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (response.ok) {
      const task = await response.json();
      if (!loadedPublicTaskIds.has(task.id)) {
        renderPublicTask(task, task.editable);
        loadedPublicTaskIds.add(task.id);
      }
    } else {
      alert("æ‰¾ä¸åˆ°å¯¹åº”çš„å…¬å…±ä»»åŠ¡");
    }
  }

  function renderPublicTask(task, editable) {
    const container = document.getElementById('public-task-view');
    const card = document.createElement('div');
    card.className = "card bg-info bg-opacity-25 text-white mt-3";
    card.id = `public-task-${task.id}`;
    card.innerHTML = `
      <div class="card-body">
        <h6>é¢‘é“ç ï¼š${task.channel_code}</h6>
        <h5>${task.title}</h5>
        <p>${task.content}</p>
        ${editable ? `
          <button class="btn btn-outline-warning btn-sm me-2" onclick="editPublicTask(${task.id}, '${task.title}', '${task.content}')">ç¼–è¾‘</button>
          <button class="btn btn-outline-danger btn-sm" onclick="deletePublicTask(${task.id})">åˆ é™¤</button>
        ` : ''}
      </div>
    `;
    container.appendChild(card);
  }

  async function editPublicTask(id, oldTitle, oldContent) {
    const newTitle = prompt("ä¿®æ”¹å…¬å…±ä»»åŠ¡æ ‡é¢˜ï¼š", oldTitle);
    const newContent = prompt("ä¿®æ”¹å…¬å…±ä»»åŠ¡å†…å®¹ï¼š", oldContent);
    if (!newTitle || !newContent) return;
    const response = await fetch(`http://localhost:8001/public_tasks/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ title: newTitle, content: newContent })
    });
    if (response.ok) {
      const updated = await response.json();
      document.getElementById(`public-task-${id}`).remove();
      renderPublicTask(updated, true);
    } else {
      alert("æ›´æ–°å¤±è´¥");
    }
  }

  async function deletePublicTask(id) {
    const confirmed = confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå…¬å…±ä»»åŠ¡å—ï¼Ÿ");
    if (!confirmed) return;
    const response = await fetch(`http://localhost:8001/public_tasks/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (response.ok) {
      alert("å·²åˆ é™¤");
      const card = document.getElementById(`public-task-${id}`);
      if (card) card.remove();
      loadedPublicTaskIds.delete(id);
    } else {
      alert("åˆ é™¤å¤±è´¥");
    }
  }
</script>
</body>
</html>
